<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirecionamento WhatsApp</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f4f4f4;
        }
        .loader {
            text-align: center;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="loader">
        <div class="spinner"></div>
        <h2>Redirecionando...</h2>
        <p>Aguarde um momento</p>
    </div>
    <script>
        // Função para obter parâmetros da URL de forma mais simples
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // Função para decodificar dados da URL de forma mais robusta
        function decodeData(encoded) {
            try {
                return JSON.parse(atob(encoded));
            } catch (e) {
                console.error('Erro na decodificação:', e);
                return null;
            }
        }

        // Função principal de redirecionamento
        async function redirectToNextNumber() {
            let numbers = [];
            
            // Tenta obter dados da URL
            const encodedData = getQueryParam('data');
            if (encodedData) {
                const decodedData = decodeData(encodedData);
                if (decodedData && Array.isArray(decodedData)) {
                    numbers = decodedData;
                }
            }

            // Se não houver números na URL, tenta buscar dados de uma API ou arquivo online
            if (numbers.length === 0) {
                try {
                    const response = await fetch('https://seuservidor.com/numeros.json');  // URL do arquivo JSON
                    if (response.ok) {
                        numbers = await response.json();
                    }
                } catch (e) {
                    console.error('Erro ao buscar dados online:', e);
                }
            }

            // Se ainda não houver números, tenta o localStorage
            if (numbers.length === 0) {
                try {
                    const stored = localStorage.getItem('activeNumbers');
                    if (stored) {
                        const parsed = JSON.parse(stored);
                        numbers = parsed.filter(n => n.status === 'Ativo');
                    }
                } catch (e) {
                    console.error('Erro ao ler localStorage:', e);
                }
            }

            // Obtém o índice atual
            let currentIndex = 0;
            try {
                currentIndex = parseInt(sessionStorage.getItem('currentIndex') || '0');
            } catch (e) {
                console.error('Erro ao ler índice:', e);
            }

            // Se houver números ativos
            if (numbers.length > 0) {
                // Reinicia o índice se necessário
                if (currentIndex >= numbers.length) {
                    currentIndex = 0;
                }

                // Obtém o número atual
                const number = numbers[currentIndex];

                // Incrementa o índice para o próximo uso
                currentIndex = (currentIndex + 1) % numbers.length;
                try {
                    sessionStorage.setItem('currentIndex', currentIndex.toString());
                } catch (e) {
                    console.error('Erro ao salvar índice:', e);
                }

                // Redireciona para o WhatsApp
                const message = number.message || "oii vi seu anuncio";
                const whatsappUrl = `https://wa.me/${number.phoneNumber}?text=${encodeURIComponent(message)}`;
                window.location.href = whatsappUrl;
            } else {
                // Se não houver números, tenta redirecionar para URL alternativa
                const fallbackUrl = localStorage.getItem('fallbackUrl');
                if (fallbackUrl) {
                    window.location.href = fallbackUrl;
                } else {
                    alert('Nenhum número ativo disponível!');
                    window.close();
                }
            }
        }

        // Inicia o redirecionamento após um breve delay
        setTimeout(redirectToNextNumber, 1500);
    </script>
</body>
</html>
